<html>

<head>
    <meta charset="utf-8">
    <title>Socket</title>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <link rel="stylesheet" href="./css/index.css" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
</head>

<body>
    <div class="container">
        <div class="inner-headerarea">
            <div class="headerh1">
                <h1 id="roomtitle">üòê</h1>
            </div>
        </div>
        <div class="row">
            <div class="mcol col-md-12 col-xs-12 col-xl-4">
                <input id="nickname"><button class="confirmNickname btn btn-success">confirm nickname</button>
                <div class="roomBtns">
                    <button class="roombtn btn btn-secondary" data-num="1">default room</button>
                    <div id="hidedDiv" style="display: none;">
                        <div class="rooms" id="rooms">
                        </div>
                        <div class="center">
                            <button class="createRoom btn btn-primary rounded-circle" data-num="+">+</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mcol col-md-12 col-xs-12  col-xl-8">
                <div class="inner-chatarea">
                    <div id="chats"></div>
                    <div class="input-group mb-3">
                        <input type="text" id="chat" class="form-control">
                        <div class="input-group-append">
                            <button id="send" class="btn btn-outline-secondary btn-warning" type="button"
                                disabled="true">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


</body>

<script>
    function Chatter() {
        this.curRoom = null;
        this.nickname = null;

        this.drawRooms = function (rooms) {
            $('#rooms').empty();
            for (room of rooms) {
                let btn = $(`<button>${room.room_name}</button>`);
                btn.addClass('roombtn btn btn-secondary').attr('data-num', room.room_idx);
                $('#rooms').append(btn);
            }
        }

        this.joinRoom = function (e) {

            if (this.curRoom) {
                this.leaveRoom();
            }

            let roomNum = e.target.getAttribute('data-num');
            this.curRoom = roomNum;
            document.getElementById('roomtitle').innerHTML = `ROOM NAME: < ${e.target.innerHTML} >`;

            socket.emit('joinRoom', this.curRoom, nickname.value);

            this.getChatLog(roomNum);
        }

        this.getChatLog = function (roomNum) {
            fetch(`/chatlist?roomNum=${roomNum}`)
                .then(r => r.json())
                .then(r => this.drawChat(r))
        }

        this.drawChat = function (r) {
            $('#chats').empty();
            for (let msg of r) {
                this.drawMessage(msg.message, msg.sender);
            }
        }

        this.drawMessage = function (msg, name) {

            let directionDiv = document.createElement('div');
            let msgSpan = document.createElement('span');

            if (name === chatter.nickname) {
                msgSpan.classList.add('alert-warning', 'rounded')
                directionDiv.style.textAlign = 'right';
                msgSpan.innerText = msg;
            } else {
                msgSpan.classList.add('alert-light', 'rounded')
                directionDiv.style.textAlign = 'left';
                directionDiv.innerHTML = name + '<br>';
                msgSpan.innerText = msg;
            }
            msgSpan.classList.add('msg');
            directionDiv.classList.add('msgdiv');
            directionDiv.appendChild(msgSpan);
            document.getElementById('chats').appendChild(directionDiv);
        }

        this.leaveRoom = function () {
            socket.emit('leaveRoom', this.curRoom, this.nickname);
            this.curRoom = null;
        }

        this.setNickname = function (e) {
            let nickInput = document.getElementById('nickname');
            if (!nickInput.value) {
                Swal.fire({
                    title: 'Warning',
                    text: 'invalid name!',
                    icon: 'warning',
                    confirmButtonText: 'Okay'
                });
                return false;
            }
            e.target.disabled = true;
            nickInput.readOnly = true;
            this.nickname = nickInput.value;
            e.target.innerHTML = `your name: ${this.nickname}`;

            socket.emit('getRoomList_solo', { socketId: socket.id, nickname: this.nickname })
            //
            document.getElementById('hidedDiv').style.display = 'block';
            document.getElementById('send').disabled = false;

        }

        this.createRoom = function () {
            let roomName = null;
            Swal.fire({
                title: 'room name?',
                input: 'text',
                inputAttributes: {
                    autocapitalize: 'off'
                },
                showCancelButton: true,
                confirmButtonText: 'Submit',
                showLoaderOnConfirm: true,
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed) {
                    if (!result.value) {
                        Swal.fire({
                            title: 'Warning',
                            text: 'invalid value!',
                            icon: 'warning',
                            confirmButtonText: 'Okay'
                        });
                        return false;
                    }
                    roomName = result.value;
                    socket.emit('createRoom', { roomName: roomName, nickname: this.nickname })
                }
            })
        }
    }
    const chatter = new Chatter();
    const socket = io();
    socket.on('msgToRoom', (d) => {
        chatter.drawMessage(d.msg, d.nickname);
    })

    socket.on('roomList', (rooms) => {
        chatter.drawRooms(rooms);
    });
    socket.on('msgToRoom_leaveRoom', (d) => {
        console.log(`${d} has left the room`);
    })
    socket.on('msgToRoom_joinRoom', (d) => {
        console.log(`${d} has joined the room`);
    })
    socket.on('roomCreated', function (obj) {
        socket.emit('getRoomList', { socketId: socket.id, nickname: this.nickname })
    })



    let chat = document.getElementById('chat');
    chat.addEventListener('keydown', (e) => {
        if (e.keyCode !== 13) return false;
        document.getElementById('send').click();
    })



    document.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') return false;

        if (e.target.className.includes('roombtn')) {
            chatter.joinRoom(e);
        }

        if (e.target.className.includes('confirmNickname')) {
            chatter.setNickname(e);
        }

        if (e.target.className.includes('createRoom')) {
            chatter.createRoom(e);
        }

        if (e.target.id === 'send') {
            socket.emit('msgToServer', chatter.curRoom, chatter.nickname, chat.value);
            chat.value = '';
        }

    })


</script>


</html>