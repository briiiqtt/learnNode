<html>

<head>
    <meta charset="utf-8">
    <title>Socket</title>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <link rel="stylesheet" href="./css/index.css" type="text/css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
</head>

<body>
    <div class="container-fluid cf1">
        <div id="display-header" class="dp header">
            <div id="headertitle">„Öé„Öá</div>
            <div>
                <i class="margin10 bi bi-search"></i>
                <i class="createroom margin10 bi bi-plus-square"></i>
                <i class="margin10 bi bi-gear"></i>
            </div>
        </div>
        <div id="display-login" style="display: block;" class="dp">
            <input id="userName" placeholder="Ïù¥Î¶Ñ">
            <div class="confirmusername btn btn-success">Ï†úÏ∂ú</div>
        </div>
        <div id="display-userlist" style="display: none;" class="dp">
            <div class="ggupdegi"></div>
        </div>
        <div id="display-roomlist" style="display: none;" class="dp">
            <div id="roomlist">
                <ul id="roomsul" class="list-group list-group">
                </ul>
                <div class="rooms" id="rooms">
                </div>
            </div>
        </div>
        <div id="display-chat" style="display: none;" class="dp">
            <div class="chatarea">
                <div class="navbar">
                    <i id="backarrow" class="bi bi-box-arrow-left h1 margin10"></i>
                    <div class="h1 margin10" id="roomtitle">üòê</div>
                    <i class="bi bi-list h1 margin10"></i>
                </div>
                <div id="chats"></div>
                <div class="input-group mb-3 footer">
                    <input type="text" id="chat" class="form-control">
                    <div class="input-group-append">
                        <div id="send" class="btn btn-outline-secondary btn-warning" type="button" disabled="true">
                            <i class="bi bi-arrow-up-circle h2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="display-settings" style="display: none;" class="dp">
            <div class="ggupdegi"></div>
        </div>
        <div id="display-footer" style="display: block;" class="container-fluid cf2 dp">
            <div class="row">
                <div class="footbox col menu-userlist">
                    <i class="bi bi-people menu-userlist" id="i-userlist"></i>
                </div>
                <div class="footbox col menu-chatlist">
                    <i class="bi bi-chat-dots menu-chatlist" id="i-chatlist"></i>
                </div>
                <div class="footbox col menu-settings">
                    <i class="bi bi-three-dots menu-settings" id="i-settings"></i>
                </div>
            </div>
        </div>
    </div>


</body>

<script>
    let lastSender = null;
    function Chatter() {
        this.curRoom = null;
        this.userName = null;

        this.drawRooms = function (rooms) {
            $('#roomsul').empty();
            for (room of rooms) {
                $('#roomsul').append(
                    `<li class="roomli list-group-item" data-num="${room.room_idx}" data-roomname="${room.room_name}">
                        <div class="row">
                            <div class="col-2 li-left">
                                <img src="./public/img/dummy.png" class="img-fluid rounded-circle peusa">
                            </div>
                            <div class="col-8" li-mid>
                                <div class="li-roomname">${room.room_name}</div>
                                <div class="li-lastmsg">last_msg</div>
                            </div>
                            <div class="col-2 li-right">
                                <div class="li-datetime">hh24:mi</div>
                                <span class="li-badge badge bg-primary rounded-pill">11</span>
                            </div>
                        </div>
                    </li>`);
            }
        }

        this.joinRoom = function (e) {

            if (this.curRoom) {
                this.leaveRoom();
            }

            let roomNum = e.target.closest('.roomli').getAttribute('data-num');
            this.curRoom = roomNum;
            document.getElementById('roomtitle').innerHTML = e.target.closest('.roomli').getAttribute('data-roomname');

            socket.emit('joinRoom', this.curRoom, userName.value);

            this.getChatLog(roomNum);
        }

        this.getChatLog = function (roomNum) {
            fetch(`/chatlist?roomNum=${roomNum}`)
                .then(r => r.json())
                .then(r => this.drawChat(r))
        }

        this.drawChat = function (r) {
            $('#chats').empty();
            for (let msg of r) {
                this.drawMessage(msg.message, msg.sender, msg.sent_datetime);
            }
        }

        this.drawMessage = function (msg, userName, dateTime) {
            let myMsg = `
                <div class="msgdiv" style="text-align: right;">
                    <span>${dateTime}</span>
                    <span class="alert-warning rounded msg">${msg}</span>
                </div>`;

            let othersInitialMsg = `
                    <div class="msgdiv" style="text-align: left;">
                        <div>${userName}</div>
                        <div>
                            <img src="./public/img/dummy.png" class="img-fluid rounded-circle chat-peusa"></div>
                        &emsp;&emsp;&emsp;<span class="alert-light rounded msg">${msg}</span>
                        <span>${dateTime}</span>
                    </div>`;

            let othersContinuousMsg = `
                    <div class="msgdiv" style="text-align: left;">
                        <div>
                        &emsp;&emsp;&emsp;<span class="alert-light rounded msg">${msg}</span>
                        <span>${dateTime}</span>
                    </div>`;


            if (userName === chatter.userName) {
                $('#chats').prepend(myMsg);
            } else {
                if (!document.getElementById('chats').childNodes[1]) {
                    $('#chats').prepend(othersInitialMsg);
                } else {
                    if (lastSender === userName) {
                        $('#chats').prepend(othersContinuousMsg);
                    } else {
                        $('#chats').prepend(othersInitialMsg);
                    }
                }

            }
            lastSender = userName;
        }

        this.leaveRoom = function () {
            socket.emit('leaveRoom', this.curRoom, this.userName);
            this.curRoom = null;
        }

        this.setUserName = function (e) {
            let nameInput = document.getElementById('userName');
            if (!nameInput.value) {
                Swal.fire({
                    title: 'ÏïåÎ¶º',
                    text: 'Ïú†Ìö®ÌïòÏßÄÏïäÏùå!',
                    icon: 'warning',
                    confirmButtonText: '„Öá„Öã'
                });
                return false;
            }
            e.target.disabled = true;
            nameInput.readOnly = true;
            this.userName = nameInput.value;
            e.target.innerHTML = `your userName: ${this.userName}`;

            socket.emit('getRoomList_solo', { socketId: socket.id, userName: this.userName })
            //
            this.toggleDisplay('display-roomlist')
            document.getElementById('send').disabled = false;

        }

        this.createRoom = function () {
            let roomName = null;
            Swal.fire({
                title: 'Î∞© Ï†úÎ™©?',
                input: 'text',
                inputAttributes: {
                    autocapitalize: 'off'
                },
                showCancelButton: true,
                confirmButtonText: 'ÏÉùÏÑ±',
                cancelButtonText: 'Ï∑®ÏÜå',
                showLoaderOnConfirm: true,
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed) {
                    if (!result.value) {
                        Swal.fire({
                            title: 'Warning',
                            text: 'invalid value!',
                            icon: 'warning',
                            confirmButtonText: '„Öá„Öã'
                        });
                        return false;
                    }
                    roomName = result.value;
                    socket.emit('createRoom', { roomName: roomName, userName: this.userName })
                }
            })
        }

        this.toggleDisplay = function (cmd) {
            let displays = document.getElementsByClassName('dp');
            let hdTitle = document.getElementById('headertitle');
            for (let dp of displays) {
                dp.style.display = 'none';
            }
            document.getElementById(cmd).style.display = 'block';

            switch (cmd) {
                case 'display-userlist':
                    hdTitle.innerHTML = 'ÏπúÍµ¨';
                    break;
                case 'display-roomlist':
                    hdTitle.innerHTML = 'Ï±ÑÌåÖ';
                    break;
                case 'display-settings':
                    hdTitle.innerHTML = 'ÎçîÎ≥¥Í∏∞';
                    break;
            }

            if (cmd === 'display-chat') {
                this.toggleHeaderAndFooter(false);
            } else {
                this.toggleHeaderAndFooter(true);
            }
        }

        this.toggleHeaderAndFooter = function (bool) {
            if (bool) {
                document.getElementById('display-header').style.display = 'flex';
                document.getElementById('display-footer').style.display = 'block';
            } else {
                document.getElementById('display-header').style.display = 'none';
                document.getElementById('display-footer').style.display = 'none';
            }
        }
    }
    const chatter = new Chatter();
    const socket = io();
    socket.on('msgToRoom', (d) => {
        chatter.drawMessage(d.msg, d.userName, d.dateTime);
    })

    socket.on('roomList', (rooms) => {
        chatter.drawRooms(rooms);
    });
    socket.on('msgToRoom_leaveRoom', (d) => {
        console.log(`${d} has left the room`);
    })
    socket.on('msgToRoom_joinRoom', (d) => {
        console.log(`${d} has joined the room`);
    })
    socket.on('roomCreated', function (obj) {
        socket.emit('getRoomList', { socketId: socket.id, userName: this.userName })
    })



    let chat = document.getElementById('chat');
    chat.addEventListener('keydown', (e) => {
        if (e.keyCode !== 13) return false;
        document.getElementById('send').click();
    })

    const getDateTimeString = function () {
        let dt = new Date();
        function treatUnderTen(a) {
            return a < 10 ? '0' + a : a;
        }
        let year = dt.getYear() + 1900;
        let month = treatUnderTen(dt.getMonth() + 1)
        let date = treatUnderTen(dt.getDate());
        let hour = treatUnderTen(dt.getHours());
        let min = treatUnderTen(dt.getMinutes());
        let sec = treatUnderTen(dt.getSeconds());
        return `${year}-${month}-${date} ${hour}:${min}:${sec}`;
    }


    document.addEventListener('click', (e) => {
        if (e.target.tagName === 'DIV') {


            // if (e.target.className.includes('roomli')) {
            if (e.target.closest('.roomli')) {
                chatter.joinRoom(e);
                chatter.toggleDisplay('display-chat')
            }

            if (e.target.className.includes('confirmusername')) {
                chatter.setUserName(e);
            }

            if (e.target.id === 'send') {
                if (!chat.value) return false;
                socket.emit('msgToServer', chatter.curRoom, chatter.userName, chat.value, getDateTimeString());
                chat.value = '';
            }
        }
        if (e.target.tagName === 'I') {
            if (e.target.id === 'backarrow') {
                chatter.toggleDisplay('display-roomlist')
                chatter.toggleHeaderAndFooter(true);
            }

            if (e.target.className.includes('createroom')) {
                chatter.createRoom(e);
            }
        }

        if (e.target.className.includes('menu-')) {
            let user = document.getElementById('i-userlist')
            let chat = document.getElementById('i-chatlist')
            let sett = document.getElementById('i-settings')

            if (e.target.className.includes('menu-userlist')) {
                chat.classList.remove('bi-chat-dots-fill')
                chat.classList.add('bi-chat-dots')
                sett.classList.remove('bi-three-dots-vertical')
                sett.classList.add('bi-three-dots')

                user.classList.remove('bi-people')
                user.classList.add('bi-people-fill')

                chatter.toggleDisplay('display-userlist')
            }
            if (e.target.className.includes('menu-chatlist')) {
                user.classList.remove('bi-people-fill')
                user.classList.add('bi-people')
                sett.classList.remove('bi-three-dots-vertical')
                sett.classList.add('bi-three-dots')

                chat.classList.remove('bi-chat-dots')
                chat.classList.add('bi-chat-dots-fill')

                chatter.toggleDisplay('display-roomlist')

            }
            if (e.target.className.includes('menu-settings')) {
                user.classList.remove('bi-people-fill')
                user.classList.add('bi-people')
                chat.classList.remove('bi-chat-dots-fill')
                chat.classList.add('bi-chat-dots')

                sett.classList.remove('bi-three-dots')
                sett.classList.add('bi-three-dots-vertical')

                chatter.toggleDisplay('display-settings')

            }
        }
    })


</script>


</html>